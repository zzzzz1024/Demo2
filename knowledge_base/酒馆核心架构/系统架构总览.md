# SillyTavern 生态系统架构总览

## 核心组件关系图

```
SillyTavern (核心应用)
├── AI 集成层
│   ├── OpenAI API
│   ├── Claude API
│   └── 本地模型支持
├── 数据管理层
│   ├── 角色卡系统
│   ├── 世界书管理
│   └── 聊天历史
├── 扩展系统
│   ├── TavernHelper (JS-Slash-Runner)
│   ├── MagVarUpdate
│   └── 自定义扩展
└── 用户界面层
    ├── Vue.js 组件
    ├── 主题系统
    └── 响应式布局
```

## TavernHelper 核心架构

### 系统组件

1. **Extension Architecture**: 基于iframe的沙箱环境
2. **Script Repository System**: 脚本仓库和管理系统
3. **Variable Management System**: 四级作用域变量管理
4. **Message Processing System**: 消息处理和宏替换
5. **Iframe Communication System**: 客户端-服务器通信
6. **User Interface System**: 模板化UI渲染

### 变量作用域层次

```
Global Scope (全局)
└── Character Scope (角色)
    └── Chat Scope (聊天)
        └── Message Scope (消息)
```

### 事件驱动架构

- **Extension Events**: 扩展生命周期事件
- **Chat Events**: 聊天消息事件
- **UI Events**: 用户界面交互事件
- **System Events**: 系统状态变化事件

## 数据流向分析

### 输入处理流程

1. 用户输入 → 预处理
2. 世界书触发检查
3. 变量和宏替换
4. 脚本处理
5. AI模型调用
6. 响应后处理
7. 界面更新

### 变量管理流程

1. 变量定义和初始化
2. 作用域继承和覆盖
3. 运行时更新和同步
4. 持久化存储
5. 跨会话恢复

## 扩展开发模式

### 脚本开发

- JavaScript执行环境
- TavernHelper API调用
- 事件监听和响应
- 异步操作支持

### 界面开发

- Vue.js组件系统
- 主题兼容设计
- 响应式布局
- 用户交互处理

### 数据集成

- 变量系统集成
- 存储API使用
- 配置管理
- 状态同步

## 性能优化考虑

### 内存管理

- 变量作用域清理
- 事件监听器管理
- 组件生命周期控制

### 网络优化

- API调用缓存
- 批量数据传输
- 异步处理机制

### 用户体验

- 界面响应速度
- 错误处理机制
- 进度反馈系统
