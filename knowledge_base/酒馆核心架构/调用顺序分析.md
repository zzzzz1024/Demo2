# 预设与世界书、脚本、正则的调用顺序

## SillyTavern 核心处理流程

### 1. 消息处理优先级

1. **预设(Preset)**：首先应用AI模型预设配置
2. **世界书(Worldbook)**：根据触发条件注入上下文信息
3. **正则表达式(Regex)**：对消息内容进行模式匹配和替换
4. **脚本执行**：通过TavernHelper执行自定义JavaScript逻辑

### 2. TavernHelper 变量管理作用域

```
全局变量(Global) -> 角色变量(Character) -> 聊天变量(Chat) -> 消息变量(Message)
```

### 3. 详细执行顺序

#### 阶段1：预处理

- 加载角色卡配置
- 应用预设参数
- 初始化变量作用域

#### 阶段2：上下文构建

- 世界书条目检查和激活
- 角色记忆和设定注入
- 历史消息上下文构建

#### 阶段3：消息处理

- 用户输入预处理
- 正则表达式匹配和替换
- 宏命令展开
- 变量替换

#### 阶段4：脚本执行

- TavernHelper脚本触发
- 事件系统响应
- 自定义逻辑执行

#### 阶段5：AI调用

- 构建最终prompt
- 发送到AI模型
- 接收响应

#### 阶段6：后处理

- 响应内容处理
- 正则表达式后处理
- 输出格式化
- 历史记录保存

## 关键交互点

### 世界书触发机制

- 关键词匹配优先级
- 递归触发控制
- 上下文长度管理

### 脚本介入时机

- 消息发送前(`beforeSend`)
- 消息接收后(`afterReceive`)
- 用户输入时(`onInput`)
- 界面事件(`onUI`)

### 变量作用域继承

```javascript
// 变量查找顺序
message.var || chat.var || character.var || global.var
```
